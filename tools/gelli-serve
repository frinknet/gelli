#!/usr/bin/env sh
set -e

# ── user-overridables ───────────────────────────────────────────
PORT=${1:-${GELLI_PORT:-7771}}
shift || true
MODEL=${1:-${GELLI_MODEL:-Qwen/Qwen2.5-0.5B-Instruct}}
shift || true
LORAS=${*:-${GELLI_LORAS:-}}
CTX_SIZE=${GELLI_CTXSIZE:-131072}
FLAGS=""

MODEL=$(gelli-model $MODEL)
LORAS=$(gelli-lora $LORAS)

# ── collect LoRA adapters (env list or auto-scan) ──────────────
if [ -n "$LORAS" ]; then
  for f in $LORAS; do FLAGS="$FLAGS --lora /lora/$f.gruf"; done
fi

exec llama-server --model "/models/$(basename "$MODEL").gguf" $FLAGS --port "$PORT" --ctx-size $CTX_SIZE
