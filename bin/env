#!/usr/bin/env sh
set -e

error() {
  echo $@ >&2

  exit 1
}

safety() {
  local dir=$(echo "$PWD/./${1#$PWD}" | awk -F/ '
    {
      n = split($0, a, "/")
      out = ""

      for(i=1;i<=n;i++){
  if(a[i]=="."||a[i]=="") continue
  else if(a[i]=="..") sub("/[^/]+$", "", out)
  else out=out"/"a[i]
      }

      print out ? out : "/"
    }
  ')

  echo ".${dir#$PWD}"
}

tooling() {
  [ ! -t 0 ] && echo "${1:-"{}"}" | exec jq .

  json=$(cat)

  for key in $(echo "$json" | jq -r 'keys[]'); do
    value=$(echo "$json" | jq -r ".\"$key\" // empty")

    case "$key" in
      dir) eval "$key=\$(safety '$value')";;
      file) [ -n "$value" ] && eval "$key=\$(safety '$value')";;
      *) eval "$key='$value'"
    esac
  done
}

prefix() {
  for file in "$DIR/$1"/*; do
    alias "$2-$(basename "$file")"="$file"
  done
  for file in ".$BIN/$1"/*; do
    alias "$2-$(basename "$file")"="$file"
  done
}

CHAR=
SHELL=

export ENV="$0"
export DIR="${0%/bin/env}"
export BIN="${DIR##*/}"
export PS1="\n\[\e[1;91m\]  \w \[\e[38;5;52m\]\$\[\e[0m\] \[\e]12;#999900\007\]\[\e]12;#999900\007\]\[\e[3 q\]"

prefix bin "$BIN"
prefix tools tool
prefix agents agent

[ "$1" = "sh" ] && SHELL="$1" && shift
[ -n "$1" ] && CHAR="${1:0:1}"
[ "$CHAR" =  "{" ] && tooling "$1" && shift
[ -n "$SHELL" ] && exec sh "$@"
