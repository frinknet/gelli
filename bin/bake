#!/bin/env sh

MODEL=""
LORAS=""
OUTPUT=""
FLAGS=""

for arg in "$@"; do
  case "$arg" in
    lora=*) LORAS="$LORAS ${arg#lora=}" ;;
    *) 
      if [ -z "$MODEL" ]; then
        MODEL="$arg"
      else 
    *) OUTPUT="$arg" ;;
  esac
done

if [ -z "$MODEL" ] || [ -z "$OUTPUT" ] || [ -z "$LORAS" ]; then
  echo "Usage: gelli bake MODEL lora=LORA:WEIGHT [lora=LORA2:WEIGHT] OUTPUT.gguf" >&2
  exit 1
fi

for lora_spec in $LORAS; do
    if [[ "$lora_spec" == *":"* ]]; then
        LORA_NAME="${lora_spec%%:*}"
        WEIGHT="${lora_spec##*:}"
        FLAGS="$FLAGS --lora-scaled /loras/$LORA_NAME.gguf $WEIGHT"
    else
        FLAGS="$FLAGS --lora-scaled /loras/$lora_spec.gguf 1.0"
    fi
done

echo "â†’ Baking $LORAS into $MODEL"

MODEL=$(models $MODEL)

llama-export-lora --model-base "/models/$MODEL.gguf" --model-out "$OUTPUT.gguf" $FLAGS
